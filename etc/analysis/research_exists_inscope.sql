
-- _/_/_/_/_/_/_/_/_/_/_/_/_/_/_/_/_/_/_/_/_/_/_/_/_/_/_/_/_/_/_/_/_/_/_/_/_/_/_/_/
-- 
-- existsSubQuery と inScopeSubQuery のパフォーマンスの違い
-- 
-- _/_/_/_/
-- GIANT :: 300万件
-- GIANT_REF :: 1000万件

-- =======================================================================================
--                                                                       外側多くて内側少ない
--                                                                       =================
-- _/_/_/_/_/_/_/_/_/_/
-- まず件数の確認
-- _/_/_/_/
select count(*)
  from GIANT_REF ref
 where ref.INDEX_DATE = '2000-01-01'
+----------+
| count(*) |
+----------+
|      152 |
+----------+
1 row in set (0.01 sec)

-- _/_/_/_/_/_/_/_/_/_/_/_/
-- exists SubQuery
-- _/_/_/_/
select count(*)
  from GIANT gi
 where exists (select ref.GIANT_REF_ID
                 from GIANT_REF ref
                where ref.GIANT_ID = gi.GIANT_ID
                  and ref.INDEX_DATE = '2000-01-01'
       )
+----------+
| count(*) |
+----------+
|      152 |
+----------+
1 row in set (1 min 59.53 sec)
-- (MySQL-5.7.13)
+----+--------------------+-------+------------+-------+----------------------------------------------------------------+----------------------------------------+---------+-----------------------+---------+----------+--------------------------+
| id | select_type        | table | partitions | type  | possible_keys                                                  | key                                    | key_len | ref                   | rows    | filtered | Extra                    |
+----+--------------------+-------+------------+-------+----------------------------------------------------------------+----------------------------------------+---------+-----------------------+---------+----------+--------------------------+
|  1 | PRIMARY            | gi    | NULL       | index | NULL                                                           | IX_GIANT_INDEX_BOOLEAN                 | 1       | NULL                  | 2897937 |   100.00 | Using where; Using index |
|  2 | DEPENDENT SUBQUERY | ref   | NULL       | ref   | IX_GIANT_REF_INDEX_DATE,IX_GIANT_REF_COMPOUND_GIANT_ID_INTEGER | IX_GIANT_REF_COMPOUND_GIANT_ID_INTEGER | 8       | maihamadb.gi.GIANT_ID |       3 |     1.51 | Using where              |
+----+--------------------+-------+------------+-------+----------------------------------------------------------------+----------------------------------------+---------+-----------------------+---------+----------+--------------------------+
2 rows in set, 2 warnings (0.01 sec)
+-------+------+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| Level | Code | Message                                                                                                                                                                                                                                                                                                     |
+-------+------+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| Note  | 1276 | Field or reference 'maihamadb.gi.GIANT_ID' of SELECT #2 was resolved in SELECT #1                                                                                                                                                                                                                           |
| Note  | 1003 | /* select#1 */
select count(0) AS `count(*)`
  from `maihamadb`.`giant` `gi`
 where exists(/* select#2 */ select `maihamadb`.`ref`.`GIANT_REF_ID`
                               from `maihamadb`.`giant_ref` `ref`
                             where ((`maihamadb`.`ref`.`INDEX_DATE` = '2000-01-01')
                               and (`maihamadb`.`ref`.`GIANT_ID` = `maihamadb`.`gi`.`GIANT_ID`))) |
+-------+------+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+

-- _/_/_/_/_/_/_/_/_/_/_/_/
-- inScope SubQuery
-- _/_/_/_/
select count(*)
  from GIANT gi
 where gi.GIANT_ID in (select ref.GIANT_ID
                         from GIANT_REF ref
                        where ref.INDEX_DATE = '2000-01-01'
       )
+----------+
| count(*) |
+----------+
|      152 |
+----------+
1 row in set (0.02 sec)
-- (MySQL-5.7.13)
+----+--------------+-------------+------------+--------+----------------------------------------------------------------+-------------------------+---------+----------------------+------+----------+-------------+
| id | select_type  | table       | partitions | type   | possible_keys                                                  | key                     | key_len | ref                  | rows | filtered | Extra       |
+----+--------------+-------------+------------+--------+----------------------------------------------------------------+-------------------------+---------+----------------------+------+----------+-------------+
|  1 | SIMPLE       | <subquery2> | NULL       | ALL    | NULL                                                           | NULL                    | NULL    | NULL                 | NULL |   100.00 | NULL        |
|  1 | SIMPLE       | gi          | NULL       | eq_ref | PRIMARY                                                        | PRIMARY                 | 8       | <subquery2>.GIANT_ID |    1 |   100.00 | Using index |
|  2 | MATERIALIZED | ref         | NULL       | ref    | IX_GIANT_REF_INDEX_DATE,IX_GIANT_REF_COMPOUND_GIANT_ID_INTEGER | IX_GIANT_REF_INDEX_DATE | 3       | const                |  152 |   100.00 | NULL        |
+----+--------------+-------------+------------+--------+----------------------------------------------------------------+-------------------------+---------+----------------------+------+----------+-------------+
3 rows in set, 1 warning (0.00 sec)
+-------+------+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| Level | Code | Message                                                                                                                                                                                                                                   |
+-------+------+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| Note  | 1003 | /* select#1 */
select count(0) AS `count(*)`
  from `maihamadb`.`giant` `gi`
    semi join (`maihamadb`.`giant_ref` `ref`)
 where ((`maihamadb`.`gi`.`GIANT_ID` = `<subquery2>`.`GIANT_ID`)
   and (`maihamadb`.`ref`.`INDEX_DATE` = '2000-01-01')) |
+-------+------+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+



-- =======================================================================================
--                                                                       外側少なくて内側多い
--                                                                       =================
-- _/_/_/_/_/_/_/_/_/_/
-- まず件数の確認
-- _/_/_/_/
select count(*)
  from GIANT_REF ref
 where ref.INDEX_DATE >= '2024-03-21'
+----------+
| count(*) |
+----------+
|  8785935 |
+----------+
1 row in set (1.52 sec)

select count(*)
  from GIANT gi
 where gi.INDEX_INTEGER >= 95
   and gi.INDEX_INTEGER < 100
+----------+
| count(*) |
+----------+
|     1500 |
+----------+
1 row in set (0.01 sec)

-- _/_/_/_/_/_/_/_/_/_/_/_/
-- exists SubQuery
-- _/_/_/_/
select count(*)
  from GIANT gi
 where exists (select ref.GIANT_ID
                 from GIANT_REF ref
                where ref.GIANT_ID = gi.GIANT_ID
                  and ref.INDEX_DATE >= '2024-03-21'
       )
   and gi.INDEX_INTEGER >= 95
   and gi.INDEX_INTEGER < 100
+----------+
| count(*) |
+----------+
|     1417 |
+----------+
1 row in set (0.34 sec)
-- (MySQL-5.7.13)
+----+--------------------+-------+------------+-------+----------------------------------------------------------------+----------------------------------------+---------+-----------------------+------+----------+--------------------------+
| id | select_type        | table | partitions | type  | possible_keys                                                  | key                                    | key_len | ref                   | rows | filtered | Extra                    |
+----+--------------------+-------+------------+-------+----------------------------------------------------------------+----------------------------------------+---------+-----------------------+------+----------+--------------------------+
|  1 | PRIMARY            | gi    | NULL       | range | IX_GIANT_INDEX_INTEGER                                         | IX_GIANT_INDEX_INTEGER                 | 4       | NULL                  | 1500 |   100.00 | Using where; Using index |
|  2 | DEPENDENT SUBQUERY | ref   | NULL       | ref   | IX_GIANT_REF_INDEX_DATE,IX_GIANT_REF_COMPOUND_GIANT_ID_INTEGER | IX_GIANT_REF_COMPOUND_GIANT_ID_INTEGER | 8       | maihamadb.gi.GIANT_ID |    3 |    50.00 | Using where              |
+----+--------------------+-------+------------+-------+----------------------------------------------------------------+----------------------------------------+---------+-----------------------+------+----------+--------------------------+
2 rows in set, 2 warnings (0.01 sec)
+-------+------+------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| Level | Code | Message                                                                                                                                                                                                                                                                                                                                                                                              |
+-------+------+------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| Note  | 1276 | Field or reference 'maihamadb.gi.GIANT_ID' of SELECT #2 was resolved in SELECT #1                                                                                                                                                                                                                                                                                                                    |
| Note  | 1003 | /* select#1 */
select count(0) AS `count(*)`
  from `maihamadb`.`giant` `gi`
 where (exists(/* select#2 */ select `maihamadb`.`ref`.`GIANT_ID`
                                from `maihamadb`.`giant_ref` `ref`
                               where ((`maihamadb`.`ref`.`GIANT_ID` = `maihamadb`.`gi`.`GIANT_ID`)
                                 and (`maihamadb`.`ref`.`INDEX_DATE` >= '2024-03-21'))
              )
   and (`maihamadb`.`gi`.`INDEX_INTEGER` >= 95)
   and (`maihamadb`.`gi`.`INDEX_INTEGER` < 100)) |
+-------+------+------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+

-- _/_/_/_/_/_/_/_/_/_/_/_/
-- inScope SubQuery
-- _/_/_/_/
select count(*)
  from GIANT gi
 where gi.GIANT_ID in (select ref.GIANT_ID
                         from GIANT_REF ref
                        where ref.INDEX_DATE >= '2024-03-21'
       )
   and gi.INDEX_INTEGER >= 95
   and gi.INDEX_INTEGER < 100
+----------+
| count(*) |
+----------+
|     1417 |
+----------+
1 row in set (0.30 sec)
-- (MySQL-5.7.13)
+----+-------------+-------+------------+-------+----------------------------------------------------------------+----------------------------------------+---------+-----------------------+------+----------+-----------------------------+
| id | select_type | table | partitions | type  | possible_keys                                                  | key                                    | key_len | ref                   | rows | filtered | Extra                       |
+----+-------------+-------+------------+-------+----------------------------------------------------------------+----------------------------------------+---------+-----------------------+------+----------+-----------------------------+
|  1 | SIMPLE      | gi    | NULL       | range | PRIMARY,IX_GIANT_INDEX_INTEGER                                 | IX_GIANT_INDEX_INTEGER                 | 4       | NULL                  | 1500 |   100.00 | Using where; Using index    |
|  1 | SIMPLE      | ref   | NULL       | ref   | IX_GIANT_REF_INDEX_DATE,IX_GIANT_REF_COMPOUND_GIANT_ID_INTEGER | IX_GIANT_REF_COMPOUND_GIANT_ID_INTEGER | 8       | maihamadb.gi.GIANT_ID |    3 |    50.00 | Using where; FirstMatch(gi) |
+----+-------------+-------+------------+-------+----------------------------------------------------------------+----------------------------------------+---------+-----------------------+------+----------+-----------------------------+
2 rows in set, 1 warning (0.00 sec)
+-------+------+------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| Level | Code | Message                                                                                                                                                                                                                                                                                                                                  |
+-------+------+------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| Note  | 1003 | /* select#1 */
select count(0) AS `count(*)`
  from `maihamadb`.`giant` `gi`
    semi join (`maihamadb`.`giant_ref` `ref`)
 where ((`maihamadb`.`ref`.`GIANT_ID` = `maihamadb`.`gi`.`GIANT_ID`)
   and (`maihamadb`.`gi`.`INDEX_INTEGER` >= 95)
   and (`maihamadb`.`gi`.`INDEX_INTEGER` < 100)
   and (`maihamadb`.`ref`.`INDEX_DATE` >= '2024-03-21')) |
+-------+------+------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+




-- =======================================================================================
--                                                         8.0.36 でmaihama系で試してみると？
--                                                         ===============================

select count(*)
  from `MEMBER` dfloc
 where exists (select sub1loc.MEMBER_ID
                 from PURCHASE sub1loc
                where sub1loc.MEMBER_ID = dfloc.MEMBER_ID
                  and sub1loc.PURCHASE_PRICE = 1000
       )
-- (MySQL-8.0.36)
+----+--------------+-------------+------------+--------+-----------------------------------------+-------------------+---------+-----------------------+------+----------+-------------+
| id | select_type  | table       | partitions | type   | possible_keys                           | key               | key_len | ref                   | rows | filtered | Extra       |
+----+--------------+-------------+------------+--------+-----------------------------------------+-------------------+---------+-----------------------+------+----------+-------------+
|  1 | SIMPLE       | <subquery2> | NULL       | ALL    | NULL                                    | NULL              | NULL    | NULL                  | NULL |   100.00 | NULL        |
|  1 | SIMPLE       | dfloc       | NULL       | eq_ref | PRIMARY                                 | PRIMARY           | 4       | <subquery2>.MEMBER_ID |    1 |   100.00 | Using index |
|  2 | MATERIALIZED | sub1loc     | NULL       | ref    | MEMBER_ID,MEMBER_ID_2,IX_PURCHASE_PRICE | IX_PURCHASE_PRICE | 4       | const                 |    6 |   100.00 | NULL        |
+----+--------------+-------------+------------+--------+-----------------------------------------+-------------------+---------+-----------------------+------+----------+-------------+

select count(*)
  from `MEMBER` dfloc
 where dfloc.MEMBER_ID in (select sub1loc.MEMBER_ID
                             from PURCHASE sub1loc
                            where sub1loc.PURCHASE_PRICE = 1000
       )
-- (MySQL-8.0.36)
+----+--------------+-------------+------------+--------+-----------------------------------------+-------------------+---------+-----------------------+------+----------+-------------+
| id | select_type  | table       | partitions | type   | possible_keys                           | key               | key_len | ref                   | rows | filtered | Extra       |
+----+--------------+-------------+------------+--------+-----------------------------------------+-------------------+---------+-----------------------+------+----------+-------------+
|  1 | SIMPLE       | <subquery2> | NULL       | ALL    | NULL                                    | NULL              | NULL    | NULL                  | NULL |   100.00 | Using where |
|  1 | SIMPLE       | dfloc       | NULL       | eq_ref | PRIMARY                                 | PRIMARY           | 4       | <subquery2>.MEMBER_ID |    1 |   100.00 | Using index |
|  2 | MATERIALIZED | sub1loc     | NULL       | ref    | MEMBER_ID,MEMBER_ID_2,IX_PURCHASE_PRICE | IX_PURCHASE_PRICE | 4       | const                 |    6 |   100.00 | NULL        |
+----+--------------+-------------+------------+--------+-----------------------------------------+-------------------+---------+-----------------------+------+----------+-------------+



select count(*)
  from `MEMBER` dfloc
 where exists (select sub1loc.MEMBER_ID
                 from PURCHASE sub1loc
                where sub1loc.MEMBER_ID = dfloc.MEMBER_ID
                  and sub1loc.PURCHASE_PRICE >= 10
       )
  and dfloc.MEMBER_ACCOUNT = 'Pixy'
-- (MySQL-8.0.36)
+----+-------------+---------+------------+-------+-----------------------------------------+----------------+---------+-------+------+----------+--------------------------------+
| id | select_type | table   | partitions | type  | possible_keys                           | key            | key_len | ref   | rows | filtered | Extra                          |
+----+-------------+---------+------------+-------+-----------------------------------------+----------------+---------+-------+------+----------+--------------------------------+
|  1 | SIMPLE      | dfloc   | NULL       | const | PRIMARY,MEMBER_ACCOUNT                  | MEMBER_ACCOUNT | 202     | const |    1 |   100.00 | Using index                    |
|  1 | SIMPLE      | sub1loc | NULL       | ref   | MEMBER_ID,MEMBER_ID_2,IX_PURCHASE_PRICE | MEMBER_ID      | 4       | const |   10 |   100.00 | Using where; FirstMatch(dfloc) |
+----+-------------+---------+------------+-------+-----------------------------------------+----------------+---------+-------+------+----------+--------------------------------+

select count(*)
  from `MEMBER` dfloc
 where dfloc.MEMBER_ID in (select sub1loc.MEMBER_ID
                            from PURCHASE sub1loc
                           where sub1loc.PURCHASE_PRICE >= 10
       )
  and dfloc.MEMBER_ACCOUNT = 'Pixy'
-- (MySQL-8.0.36)
+----+-------------+---------+------------+-------+-----------------------------------------+----------------+---------+-------+------+----------+--------------------------------+
| id | select_type | table   | partitions | type  | possible_keys                           | key            | key_len | ref   | rows | filtered | Extra                          |
+----+-------------+---------+------------+-------+-----------------------------------------+----------------+---------+-------+------+----------+--------------------------------+
|  1 | SIMPLE      | dfloc   | NULL       | const | PRIMARY,MEMBER_ACCOUNT                  | MEMBER_ACCOUNT | 202     | const |    1 |   100.00 | Using index                    |
|  1 | SIMPLE      | sub1loc | NULL       | ref   | MEMBER_ID,MEMBER_ID_2,IX_PURCHASE_PRICE | MEMBER_ID      | 4       | const |   10 |   100.00 | Using where; FirstMatch(dfloc) |
+----+-------------+---------+------------+-------+-----------------------------------------+----------------+---------+-------+------+----------+--------------------------------+
/* select#1 */
select count(0) AS `count(*)`
  from `maihamadb`.`member` `dfloc`
    semi join (`maihamadb`.`purchase` `sub1loc`)
 where ((`maihamadb`.`sub1loc`.`MEMBER_ID` = '1')
   and (`maihamadb`.`sub1loc`.`PURCHASE_PRICE` >= 10))


